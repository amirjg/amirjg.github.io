<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Spotify High-Res</title>
    
    <!-- 1. VIEWPORT: Standard mobile viewport to start -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- 2. RESOLUTION SCALER (Must run before app loads) -->
    <script>
        (function() {
            // Target Resolution: 1080p
            const TARGET_WIDTH = 1920;
            const TARGET_HEIGHT = 1080;
            
            // Detect if we are in a constrained environment (TV or small window)
            const isLowRes = window.innerHeight <= 750;
            
            if (isLowRes) {
                console.log(">>> [SCALER] Low-Res Detected. Forcing 1080p Virtual Layout.");

                // A. Override Window Dimensions so App Logic sees 1080p
                try {
                    Object.defineProperties(window, {
                        'innerWidth': { get: function() { return TARGET_WIDTH; } },
                        'innerHeight': { get: function() { return TARGET_HEIGHT; } },
                        'outerWidth': { get: function() { return TARGET_WIDTH; } },
                        'outerHeight': { get: function() { return TARGET_HEIGHT; } }
                    });
                } catch(e) { console.warn("Resize override failed:", e); }

                // B. Apply Visual Scaling
                const applyScale = () => {
                    const html = document.documentElement;
                    const body = document.body;
                    
                    // Calculate Scale Factor (e.g. 1280 / 1920 = 0.6666)
                    const realWidth = html.clientWidth || 1280; 
                    const zoomFactor = realWidth / TARGET_WIDTH;
                    
                    // 1. Force LTR (Fixes "Top Right" alignment)
                    html.style.direction = "ltr";
                    body.style.direction = "ltr";

                    // 2. Apply Zoom (High Density)
                    html.style.zoom = zoomFactor;
                    
                    // 3. Force Body to fill the Virtual 1920px Space
                    // Since we zoomed out, the container needs to be huge to fill the screen
                    const virtualStyles = {
                        width: TARGET_WIDTH + "px",
                        height: TARGET_HEIGHT + "px",
                        maxWidth: "none",
                        minWidth: "100%",
                        overflow: "hidden",
                        position: "absolute",
                        top: "0",
                        left: "0"
                    };

                    Object.assign(body.style, virtualStyles);
                    
                    // 4. Force React Root
                    const root = document.getElementById('root');
                    if(root) Object.assign(root.style, virtualStyles);
                };

                // Run immediately and keep enforcing
                applyScale();
                window.addEventListener('DOMContentLoaded', applyScale);
                window.addEventListener('load', applyScale);
                window.addEventListener('resize', applyScale);
            }
        })();
    </script>

    <!-- 3. CSS -->
    <link rel="stylesheet" href="https://tv.scdn.co/webos4plus/v2/593b9e7/css/spotifytv.css">

    <style>
        body, html { 
            background-color: #000; 
            margin: 0; padding: 0; 
            width: 100%; height: 100%; 
            overflow: hidden; 
        }
        #root { 
            width: 100%; height: 100%; 
        }

        /* Splash Screen */
        #loadingScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 9999;
            transition: opacity 0.5s;
        }
        body.loaded #loadingScreen { opacity: 0; pointer-events: none; }
        
        .spotifyLogo {
            position: absolute; left: 0; right: 0; top: 0; bottom: 0; margin: auto;
            width: 300px; fill: #1ed760;
        }
    </style>

    <!-- 4. SYSTEM MOCKS & CONFIGURATION -->
    <script>
        // --- CRITICAL FIX: DEFINE RELEASE ---
        // Prevents the "mandatory setting missing" crash
        window.release = '593b9e7';
        window.__release = '593b9e7';

        // Spotify Config
        window.__version = '2025.12.17_0-593b9e7';
        window.__revision = '593b9e7';
        window.__basePath = 'https://tv.scdn.co/webos4plus/v2/593b9e7/';
        
        var AUTH_HASH = "M2UyOWNiMThjNGMzNGQ2MDgzN2VjOTRjZjMxZTlmM2U6NDZiYWQwZjE3MDVmNGU5MjllMmViOGU3YTM1YjQ5Mzk=";
        window.location.hash = "auth=" + AUTH_HASH;

        // Bridge Emulator
        class PalmServiceBridge {
            constructor() { this.onservicecallback = null; }
            cancel() {}
            call(url, params) {
                // console.log("[Bridge] " + url);
                let response = { returnValue: true };
                
                if (url.includes("config")) {
                    response.configs = {
                        "tv.model.modelname": "OLED65C46LA",
                        "tv.hw.panelResolution": "UD", 
                        "tv.hw.displayType": "OLED"
                    };
                }
                if (url.includes("systemproperty")) response.UHD = "true";
                if (url.includes("connectionmanager")) response.isInternetConnectionAvailable = true;

                // Async response simulation
                setTimeout(() => {
                    if (this.onservicecallback) this.onservicecallback(JSON.stringify(response));
                }, 10);
            }
        }
        window.PalmServiceBridge = PalmServiceBridge;

        // WebOS Library Mock (Clean Version)
        window.webOS = {
            platform: { tv: true, open: true },
            fetchAppId: function() { return "com.spotify.client.webos"; },
            systemInfo: function() { return { country: "ITA" }; },
            deviceInfo: function(cb) { cb(JSON.parse(window.PalmSystem.deviceInfo)); },
            service: {
                request: function(service, params) {
                    var bridge = new PalmServiceBridge();
                    var onSuccess = params.onSuccess || function(){};
                    var onFailure = params.onFailure || function(){};
                    bridge.onservicecallback = function(msg) {
                        var parsed = JSON.parse(msg);
                        if (parsed.returnValue) onSuccess(parsed);
                        else onFailure(parsed);
                    };
                    bridge.call(service, params.parameters || {});
                    return bridge;
                }
            }
        };

        // PalmSystem (Reporting 4K Hardware)
        window.PalmSystem = {
            identifier: "com.spotify.client.webos",
            launchParams: JSON.stringify({ "auth": AUTH_HASH, "query": "platform=webos4plus" }),
            country: '{"country":"ITA"}',
            locale: "it-IT",
            modelName: "OLED65C46LA",
            isActivated: true,
            deviceInfo: JSON.stringify({
                modelName: "OLED65C46LA", version: "24.0.0", sdkVersion: "24.0.0", 
                uhd: true, oled: true, ddrSize: "4G", uhd8K: false, hdr10: true, 
                brandName: "LG", manufacturer: "LG Electronics", 
                screenHeight: 2160, screenWidth: 3840
            })
        };

        // Motion Match Fix
        const originalMatchMedia = window.matchMedia;
        window.matchMedia = function(query) {
            if (query.includes('prefers-reduced-motion')) 
                return { matches: false, addListener:()=>{}, removeListener:()=>{}, addEventListener:()=>{}, removeEventListener:()=>{} };
            return originalMatchMedia.call(window, query);
        };
    </script>

    <!-- 5. ENGINE -->
    <script defer src="https://tv.scdn.co/webos4plus/v2/593b9e7/js/vendors.c2b961bdd56f55fcfed5.js"></script>
    <script defer src="https://tv.scdn.co/webos4plus/v2/593b9e7/js/spotifytv.js"></script>

</body>
</html>
